{% extends "base.html" %}

{% block title %}Hasil Prediksi - SehatinKulit{% endblock %}

{% block content %}
<div class="container">
    <div class="result-header">
        <a href="{{ url_for('predict_page') }}" class="back-link">‚Üê Kembali ke Prediksi</a>
        <h1>Hasil Prediksi</h1>
    </div>

    <div class="result-container">
        <!-- Top Prediction Card -->
        <div class="top-prediction-card">
            <div class="prediction-badge">
                <span class="badge-icon">üèÜ</span>
                <span class="badge-text">Prediksi Utama</span>
            </div>
            <h2 class="prediction-label" id="topLabel">-</h2>
            <div class="prediction-confidence">
                <span class="confidence-value" id="topConfidence">-</span>
                <span class="confidence-label">Tingkat Kepercayaan</span>
            </div>
        </div>

        <!-- Article Section - Muncul langsung setelah hasil prediksi -->
        <div class="article-section">
            <h3 class="section-title">üìö Artikel Lengkap: <span id="articleTitleDisease">-</span></h3>
            <div class="disease-info-container" id="articleInfoContainer" style="display: none;">
                <div class="disease-header">
                    <h4 id="articleDiseaseName" class="disease-name">-</h4>
                </div>

                <!-- Explanation -->
                <div class="disease-section">
                    <h4 class="disease-section-title">üìã Penjelasan</h4>
                    <p id="articleExplanation" class="disease-text">-</p>
                </div>

                <!-- Treatment -->
                <div class="disease-section">
                    <h4 class="disease-section-title">üíä Pengobatan & Perawatan</h4>
                    <ul id="articleTreatment" class="disease-treatment-list">
                        <!-- Will be populated by JavaScript -->
                    </ul>
                </div>

                <!-- Sample Images -->
                <div class="disease-section">
                    <h4 class="disease-section-title">üñºÔ∏è Contoh Gambar dari Dataset</h4>
                    <div id="articleImages" class="disease-images-grid">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Loading indicator -->
            <div class="disease-loading" id="articleLoading" style="display: none;">
                <div class="spinner-small"></div>
                <p>Memuat artikel...</p>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-section">
            <h3 class="section-title">Distribusi Probabilitas</h3>
            <div class="chart-container" id="chartContainer">
                <!-- Chart will be generated by JavaScript -->
            </div>
        </div>

        <!-- Explanation Section -->
        <div class="explanation-section">
            <h3 class="section-title">Penjelasan</h3>
            <div class="explanation-card">
                <p id="explanationText">-</p>
            </div>
        </div>

        <!-- Treatment Section -->
        <div class="treatment-section">
            <h3 class="section-title">Penanganan & Obat</h3>
            <div class="treatment-card">
                <div class="treatment-content" id="treatmentText">-</div>
            </div>
        </div>

        <!-- Article Link -->
        <div class="article-link-section">
            <a href="#" id="articleLink" class="btn btn-primary btn-large">
                üìñ Baca Artikel Selengkapnya
            </a>
        </div>

        <!-- New Prediction Button -->
        <div class="new-prediction-section">
            <a href="{{ url_for('predict_page') }}" class="btn btn-secondary btn-large">
                Prediksi Baru
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load result data from sessionStorage
    document.addEventListener('DOMContentLoaded', function() {
        const resultData = sessionStorage.getItem('predictionResult');
        if (resultData) {
            const data = JSON.parse(resultData);
            displayResult(data);
        } else {
            // Redirect if no data
            window.location.href = "{{ url_for('predict_page') }}";
        }
    });

    function displayResult(data) {
        // Top prediction
        const topLabel = data.top_label;
        document.getElementById('topLabel').textContent = formatLabel(topLabel);
        document.getElementById('topConfidence').textContent = 
            (data.top_confidence * 100).toFixed(2) + '%';

        // Explanation
        document.getElementById('explanationText').textContent = 
            data.explanation || 'Penjelasan tidak tersedia.';

        // Treatment
        document.getElementById('treatmentText').innerHTML = 
            formatTreatment(data.treatment || 'Penanganan tidak tersedia.');

        // Article link - link to artikel page with disease parameter
        const articleLink = document.getElementById('articleLink');
        articleLink.href = `/artikel?disease=${encodeURIComponent(topLabel)}`;

        // Chart
        renderChart(data.probabilities || {});

        // Load article information for the predicted disease
        loadArticleInfo(topLabel);
    }

    function formatLabel(label) {
        return label.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function formatTreatment(treatment) {
        if (typeof treatment === 'string') {
            return treatment.split('\n').map(line => `<p>${line}</p>`).join('');
        }
        return treatment;
    }

    function renderChart(probabilities) {
        const container = document.getElementById('chartContainer');
        container.innerHTML = '';

        // Sort by probability
        const sorted = Object.entries(probabilities)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5); // Top 5

        sorted.forEach(([label, prob]) => {
            const barItem = document.createElement('div');
            barItem.className = 'chart-bar-item';
            
            const barLabel = document.createElement('div');
            barLabel.className = 'chart-bar-label';
            barLabel.textContent = formatLabel(label);

            const barWrapper = document.createElement('div');
            barWrapper.className = 'chart-bar-wrapper';

            const barFill = document.createElement('div');
            barFill.className = 'chart-bar-fill';
            barFill.style.width = '0%';
            barFill.innerHTML = `<span class="bar-percentage">${(prob * 100).toFixed(1)}%</span>`;

            barWrapper.appendChild(barFill);
            barItem.appendChild(barLabel);
            barItem.appendChild(barWrapper);
            container.appendChild(barItem);

            // Animate
            setTimeout(() => {
                barFill.style.width = (prob * 100) + '%';
            }, 100);
        });
    }

    async function loadArticleInfo(diseaseName) {
        const loadingDiv = document.getElementById('articleLoading');
        const infoContainer = document.getElementById('articleInfoContainer');
        
        // Show loading
        loadingDiv.style.display = 'block';
        infoContainer.style.display = 'none';
        
        try {
            // Load disease info and images in parallel
            const [infoResponse, imagesResponse] = await Promise.all([
                fetch(`/api/disease/${encodeURIComponent(diseaseName)}`),
                fetch(`/api/disease/${encodeURIComponent(diseaseName)}/images`)
            ]);
            
            if (!infoResponse.ok || !imagesResponse.ok) {
                throw new Error('Gagal memuat informasi penyakit');
            }
            
            const infoData = await infoResponse.json();
            const imagesData = await imagesResponse.json();
            
            // Display disease info
            document.getElementById('articleDiseaseName').textContent = infoData.display_name;
            document.getElementById('articleTitleDisease').textContent = infoData.display_name;
            document.getElementById('articleExplanation').textContent = infoData.explanation;
            
            // Display treatment
            const treatmentList = document.getElementById('articleTreatment');
            treatmentList.innerHTML = '';
            if (infoData.treatment && infoData.treatment.length > 0) {
                infoData.treatment.forEach(treatment => {
                    const li = document.createElement('li');
                    li.textContent = treatment;
                    treatmentList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'Konsultasikan dengan dokter untuk penanganan yang tepat.';
                treatmentList.appendChild(li);
            }
            
            // Display images
            const imagesGrid = document.getElementById('articleImages');
            imagesGrid.innerHTML = '';
            if (imagesData.images && imagesData.images.length > 0) {
                imagesData.images.forEach(imageUrl => {
                    const div = document.createElement('div');
                    div.className = 'disease-image-item';
                    
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = infoData.display_name;
                    img.loading = 'lazy';
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.onerror = function() {
                        console.error('Error loading image:', imageUrl);
                        this.parentElement.style.display = 'none';
                    };
                    
                    div.appendChild(img);
                    imagesGrid.appendChild(div);
                });
            } else {
                const p = document.createElement('p');
                p.textContent = 'Tidak ada gambar tersedia untuk penyakit ini.';
                p.style.color = 'var(--text-secondary)';
                p.style.padding = '2rem';
                p.style.textAlign = 'center';
                imagesGrid.appendChild(p);
            }
            
            // Hide loading and show info
            loadingDiv.style.display = 'none';
            infoContainer.style.display = 'block';
            
        } catch (error) {
            console.error('Error loading article info:', error);
            loadingDiv.style.display = 'none';
            // Show error message in container
            infoContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Gagal memuat artikel. Silakan coba lagi.</p>';
            infoContainer.style.display = 'block';
        }
    }
</script>
{% endblock %}

