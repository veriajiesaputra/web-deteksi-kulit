{% extends "base.html" %}

{% block title %}Profil - Skinalyze{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="page-header-icon">ğŸ‘¤</div>
        <h1>Profil Saya</h1>
        <p>Kelola informasi akun Anda</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="profile-container">
        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-avatar">
                    <span>{{ user.username[0].upper() }}</span>
                </div>
                <div class="profile-info">
                    <h2>{{ user.full_name or user.username }}</h2>
                    <p class="profile-username">@{{ user.username }}</p>
                </div>
            </div>

            <div class="profile-details">
                <div class="detail-item">
                    <div class="detail-label">
                        <span class="detail-icon">ğŸ“§</span>
                        Email
                    </div>
                    <div class="detail-value">{{ user.email }}</div>
                </div>

                {% if user.full_name %}
                <div class="detail-item">
                    <div class="detail-label">
                        <span class="detail-icon">ğŸ‘¤</span>
                        Nama Lengkap
                    </div>
                    <div class="detail-value">{{ user.full_name }}</div>
                </div>
                {% endif %}

                {% if user.phone %}
                <div class="detail-item">
                    <div class="detail-label">
                        <span class="detail-icon">ğŸ“±</span>
                        No. Telepon
                    </div>
                    <div class="detail-value">{{ user.phone }}</div>
                </div>
                {% endif %}

                <div class="detail-item">
                    <div class="detail-label">
                        <span class="detail-icon">ğŸ“…</span>
                        Bergabung
                    </div>
                    <div class="detail-value">{{ user.created_at.strftime('%d %B %Y') if user.created_at else '-' }}</div>
                </div>
            </div>

            <div class="profile-actions">
                <a href="{{ url_for('edit_profile') }}" class="btn btn-primary">Edit Profil</a>
                <a href="{{ url_for('prediction_history') }}" class="btn btn-secondary">Lihat Semua History</a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger" onclick="return confirm('Apakah Anda yakin ingin logout?')">Logout</a>
            </div>
        </div>

        <!-- Prediction History Section -->
        <div class="profile-card">
            <div class="history-header">
                <h3>ğŸ“Š History Prediksi Terbaru</h3>
                <a href="{{ url_for('prediction_history') }}" class="view-all-link">Lihat Semua â†’</a>
            </div>

            {% if predictions %}
            <div class="history-list">
                {% for prediction in predictions %}
                <div class="history-item">
                    <div class="history-image">
                        {% if prediction.image_base64 %}
                        <img src="data:image/jpeg;base64,{{ prediction.image_base64 }}" alt="Prediction">
                        {% else %}
                        <div class="history-image-placeholder">ğŸ“·</div>
                        {% endif %}
                    </div>
                    <div class="history-info">
                        <div class="history-class">{{ prediction.predicted_class }}</div>
                        <div class="history-confidence">
                            <span class="confidence-badge">{{ "%.2f"|format(prediction.confidence * 100) }}%</span>
                            <span class="history-date">{{ prediction.created_at.strftime('%d %B %Y, %H:%M') if prediction.created_at else '-' }}</span>
                        </div>
                    </div>
                    <div class="history-actions">
                        <button class="btn-icon-small" onclick="deleteHistory({{ prediction.id }})" title="Hapus">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="history-empty">
                <p>Belum ada history prediksi. <a href="{{ url_for('predict_page') }}">Mulai prediksi sekarang!</a></p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function deleteHistory(historyId) {
    if (!confirm('Apakah Anda yakin ingin menghapus history ini?')) {
        return;
    }
    
    fetch(`/api/profile/history/${historyId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Gagal menghapus history: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat menghapus history');
    });
}
</script>
{% endblock %}

